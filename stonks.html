<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stonks Simulatorâ„¢ Candlestick Chart</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background:#f0f2f5;
    margin:0; padding:0;
    color:#333;
  }
  header {
    background: rgba(0,123,191,1);
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    padding:10px;
  }
  .stock-select {
    cursor:pointer;
    margin: 5px 10px;
    color:white;
    font-weight:bold;
    display:flex;
    align-items:center;
    user-select:none;
  }
  .stock-select img {
    height: 28px;
    margin-right: 8px;
  }
  .stock-select.selected {
    text-decoration: underline;
  }
  .container {
    max-width:900px;
    margin: 20px auto;
    background:white;
    padding:15px;
    border-radius:8px;
    box-shadow:0 0 8px rgba(0,0,0,0.1);
  }
  #chartContainer {
    position: relative;
    height: 320px;
    border:1px solid #ccc;
    border-radius:6px;
    background:#fff;
  }
  canvas {
    display: block;
    margin: 0 auto;
  }
  .controls {
    margin-top: 15px;
    text-align: center;
  }
  button {
    font-weight: bold;
    padding: 10px 20px;
    margin: 0 10px;
    cursor: pointer;
  }
  button:disabled {
    background: #ccc;
    cursor: default;
  }
  .info {
    margin-top: 10px;
    text-align:center;
    font-size:1.1em;
  }
  table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
    text-align: center;
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
  }
  th {
    background: #eee;
  }
  .profit {
    color: green;
  }
  .loss {
    color: red;
  }
  .summary {
    margin-top: 10px;
    font-weight: bold;
    font-size: 1.2em;
  }
</style>
</head>
<body>

<header id="stockHeader"></header>
<div class="container">
  <div class="info">
    Cash: $<span id="cashDisplay">1000.00</span> | Earnings: +$1 every 3 seconds
  </div>
  <div id="chartContainer">
    <canvas id="chart" width="860" height="320"></canvas>
  </div>
  <div class="controls">
    <button id="buyBtn">Buy</button>
    <button id="sellBtn">Sell</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Stock</th><th>Buy Price</th><th>Current Price</th><th>P/L ($)</th><th>P/L (%)</th>
      </tr>
    </thead>
    <tbody id="portfolioBody"></tbody>
  </table>
  <div class="summary">
    Total P/L: $<span id="totalPL">0.00</span>
  </div>
</div>

<script>
(() => {
  // Stocks & logos
  const stocks = {
    META: { logo: 'https://logo.clearbit.com/meta.com', price: 500 },
    AMZN: { logo: 'https://logo.clearbit.com/amazon.com', price: 185 },
    AAPL: { logo: 'https://logo.clearbit.com/apple.com', price: 233 },
    MSFT: { logo: 'https://logo.clearbit.com/microsoft.com', price: 430 },
    GOOGL: { logo: 'https://logo.clearbit.com/abc.xyz', price: 190 }
  };

  let currentStock = 'META';
  let cash = 1000;
  let portfolio = [];
  let transactions = [];
  const history = {};

  // Initialize history with starting price array (simulate OHLC with close only)
  for (const s in stocks) {
    history[s] = [stocks[s].price];
  }

  // HTML elements
  const stockHeader = document.getElementById('stockHeader');
  const cashDisplay = document.getElementById('cashDisplay');
  const buyBtn = document.getElementById('buyBtn');
  const sellBtn = document.getElementById('sellBtn');
  const portfolioBody = document.getElementById('portfolioBody');
  const totalPLEl = document.getElementById('totalPL');
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');

  // Compute OHLC from close price array by assuming open = previous close,
  // high = max(open, close) + small random spike, low = min(open, close) - small random dip
  function computeOHLC(prices) {
    const ohlc = [];
    for(let i=1; i<prices.length; i++) {
      const open = prices[i-1];
      const close = prices[i];
      const highBase = Math.max(open, close);
      const lowBase = Math.min(open, close);
      // Add some volatility wiggle for wick
      const high = highBase + Math.random()*3;
      const low = Math.max(1, lowBase - Math.random()*3);
      ohlc.push({open, high, low, close});
    }
    return ohlc;
  }

  function drawYAxis(minPrice, maxPrice, marginLeft, chartHeight) {
    ctx.fillStyle = "#000";
    ctx.font = "12px Arial";
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    const steps = 6;
    for(let i=0; i <= steps; i++) {
      const y = 20 + (chartHeight / steps) * i;
      const price = maxPrice - ((maxPrice - minPrice) / steps) * i;
      ctx.fillText(`$${price.toFixed(2)}`, marginLeft - 10, y);
      // horizontal grid line
      ctx.strokeStyle = "#eee";
      ctx.beginPath();
      ctx.moveTo(marginLeft, y);
      ctx.lineTo(canvas.width - 10, y);
      ctx.stroke();
    }
  }

  function drawCandlestickChart() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const prices = history[currentStock];
    if (prices.length < 2) return;

    const ohlc = computeOHLC(prices);

    const marginLeft = 50;
    const chartWidth = canvas.width - marginLeft - 20;
    const chartHeight = canvas.height - 40;
    drawYAxis(Math.min(...prices), Math.max(...prices), marginLeft, chartHeight);

    const candleWidth = Math.floor(chartWidth / ohlc.length * 0.7);
    const spacing = chartWidth / ohlc.length;

    for(let i=0; i < ohlc.length; i++) {
      const c = ohlc[i];
      const x = marginLeft + i*spacing + (spacing - candleWidth)/2;
      // convert price to y
      function yFromPrice(price) {
        const minP = Math.min(...prices);
        const maxP = Math.max(...prices);
        return 20 + ((maxP - price) / (maxP - minP)) * chartHeight;
      }
      const yOpen = yFromPrice(c.open);
      const yClose = yFromPrice(c.close);
      const yHigh = yFromPrice(c.high);
      const yLow = yFromPrice(c.low);

      // Candle color green if close>=open else red
      const candleColor = (c.close >= c.open) ? "#008000" : "#d40000";

      // Draw wick
      ctx.strokeStyle = candleColor;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x + candleWidth/2, yHigh);
      ctx.lineTo(x + candleWidth/2, yLow);
      ctx.stroke();

      // Draw candle body
      ctx.fillStyle = candleColor;
      ctx.fillRect(x, Math.min(yOpen, yClose), candleWidth, Math.abs(yClose - yOpen) || 1);
      ctx.strokeRect(x, Math.min(yOpen, yClose), candleWidth, Math.abs(yClose - yOpen) || 1);
    }

    // Draw buy/sell arrows on respective candle positions
    transactions.forEach(tx => {
      if(tx.symbol !== currentStock) return;
      const idx = tx.time - 1; // OHLC array is prices.length-1 long
      if(idx < 0 || idx >= ohlc.length) return;
      const c = ohlc[idx];
      const x = marginLeft + idx*spacing + spacing/2;
      const yClose = yFromPrice(c.close);

      ctx.fillStyle = tx.type === 'buy' ? 'green' : 'red';
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      if(tx.type === 'buy') {
        // Up arrow
        ctx.moveTo(x, yClose - 15);
        ctx.lineTo(x - 7, yClose - 3);
        ctx.lineTo(x + 7, yClose - 3);
      } else {
        // Down arrow
        ctx.moveTo(x, yClose + 15);
        ctx.lineTo(x - 7, yClose + 3);
        ctx.lineTo(x + 7, yClose + 3);
      }
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    });

    // Helper function inside so no scope issues
    function yFromPrice(price) {
      const minP = Math.min(...prices);
      const maxP = Math.max(...prices);
      return 20 + ((maxP - price) / (maxP - minP)) * chartHeight;
    }
  }

  function updateHeader() {
    stockHeader.innerHTML = '';
    for (const s in stocks) {
      const div = document.createElement('div');
      div.className = 'stock-select' + (s === currentStock ? ' selected' : '');
      div.innerHTML = `<img src="${stocks[s].logo}" alt="${s} logo"/>${s} $${stocks[s].price.toFixed(2)}`;
      div.onclick = () => {
        currentStock = s;
        updateAll();
      };
      stockHeader.appendChild(div);
    }
  }

  function updatePortfolio() {
    portfolioBody.innerHTML = '';
    let totalPL = 0;
    for (const p of portfolio) {
      const currentPrice = stocks[p.symbol].price;
      const pl = currentPrice - p.price;
      const plPct = (pl / p.price) * 100;
      totalPL += pl;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.symbol}</td>
        <td>$${p.price.toFixed(2)}</td>
        <td>$${currentPrice.toFixed(2)}</td>
        <td class="${pl>=0?'profit':'loss'}">$${pl.toFixed(2)}</td>
        <td class="${pl>=0?'profit':'loss'}">${plPct.toFixed(2)}%</td>
      `;
      portfolioBody.appendChild(tr);
    }
    totalPLEl.textContent = totalPL.toFixed(2);
  }

  function updateButtons() {
    buyBtn.disabled = cash < stocks[currentStock].price;
    sellBtn.disabled = !portfolio.find(p => p.symbol === currentStock);
  }

  buyBtn.onclick = () => {
    const price = stocks[currentStock].price;
    if (cash >= price) {
      portfolio.push({ symbol: currentStock, price });
      transactions.push({ symbol: currentStock, price, type: 'buy', time: history[currentStock].length });
      cash -= price;
      updateAll();
    }
  };

  sellBtn.onclick = () => {
    const idx = portfolio.findIndex(p => p.symbol === currentStock);
    if (idx >= 0) {
      const currentPrice = stocks[currentStock].price;
      transactions.push({ symbol: currentStock, price: currentPrice, type: 'sell', time: history[currentStock].length });
      portfolio.splice(idx, 1);
      cash += currentPrice;
      updateAll();
    }
  };

  // Passive earnings $1 every 3 sec
  setInterval(() => {
    cash += 1;
    cashDisplay.textContent = cash.toFixed(2);
    updateButtons();
  }, 3000);

  // Simulate price changes every 2 sec
  setInterval(() => {
    for (const s in stocks) {
      const delta = (Math.random() - 0.5) * 4;
      stocks[s].price += delta;
      if (stocks[s].price < 1) stocks[s].price = 1;
      history[s].push(stocks[s].price);
      if (history[s].length > 50) history[s].shift();
    }
    updateAll();
  }, 2000);

  function updateAll() {
    cashDisplay.textContent = cash.toFixed(2);
    updateHeader();
    updateButtons();
    updatePortfolio();
    drawCandlestickChart();
  }

  updateAll();
})();
</script>
</body>
</html>
